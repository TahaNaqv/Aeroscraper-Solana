
taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ ANCHOR_WALLET=~/.config/solana/id.json ANCHOR_PROVIDER_URL=http://127.0.0.1:8899 npx ts-mocha -p ./tsconfig.json -t 1000000 'tests/**/fee-*.ts'
(node:429795) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/tests/fee-admin-controls.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /home/taha/Documents/Projects/Aeroscraper/aerospacer-solana/package.json.
(Use `node --trace-warnings ...` to show where the warning was created)


  Fee Contract - Admin Controls Tests

ğŸš€ Setting up Fee Contract Admin Controls Tests...
âœ… Setup complete
  Admin: FqNr846pRM653mttRSBjAX34esPXS8YKBh8UL4jFyA84
  Non-Admin: FLh1o7g8StkvGR4g3GU7DFzwvfmXiTaYFqJ76Yg7EZ1A
  State: HHDH7YGFfAM8RDr4dLK1HKqf5jywvPmQfaj36qWBovTk
    Test 2.1: Admin Can Toggle Stake Contract (Disabled â†’ Enabled)
ğŸ”„ Toggling stake contract from disabled to enabled...
âœ… Toggle successful. TX: 3c3uGh3zvQ7k7rK81TPdNM9t46NbxSGb44ricdEyiVdCG5EBVBp4ovNkPmoSMrWTktttNwanrSFnw6EYHorFRaxf
âœ… Stake contract enabled successfully
      âœ” Should enable stake contract when toggled from disabled (416ms)
    Test 2.2: Admin Can Toggle Stake Contract (Enabled â†’ Disabled)
ğŸ”„ Toggling stake contract from enabled to disabled...
âœ… Toggle successful. TX: 3Yud1GHLq4A9eZBj9LGqF99vWCroQpdC7m6Q1wtGZUdzHxsURrVhAcN9JLxza5z6cZA7hZXrLaQAR551ETQuyMbe
âœ… Stake contract disabled successfully
      âœ” Should disable stake contract when toggled from enabled (404ms)
    Test 2.3: Admin Can Set Valid Stake Contract Address
ğŸ“ Setting stake contract address...
  New Address: 5YWbvtSK727ehaLZoqueF2npUhsQDY7jHn41WUtDrXVU
âœ… Address set. TX: 2KWXiP7DW5R1h3U7goPdY7uHsUUUhYynDteT55bW4WMeQcVNbux6HKvPAbAuVgeFjg8dk6FGuaFHTHpvWAbs5VV7
âœ… Stake contract address set successfully
      âœ” Should set stake contract address successfully (408ms)
âœ… Address updated multiple times successfully
      âœ” Should allow updating stake contract address multiple times (812ms)
    Test 2.4: Reject Invalid Stake Contract Address
ğŸ”’ Attempting to set invalid address...
âœ… Invalid address correctly rejected
  Error: AnchorError occurred. Error Code: InvalidAddress. Error Number: 6005. Error Message: Invalid address.
      âœ” Should fail with malformed address string
âœ… Empty address correctly rejected
      âœ” Should fail with empty string address
    Test 2.5: Non-Admin Cannot Toggle Stake Contract
ğŸ”’ Attempting toggle as non-admin...
âœ… Non-admin toggle correctly prevented
  Error: AnchorError caused by account: state. Error Code: Unauthorized. Error Number: 6000. Error Message: Unauthorized.
      âœ” Should fail when non-admin tries to toggle
    Test 2.6: Non-Admin Cannot Set Stake Contract Address
ğŸ”’ Attempting to set address as non-admin...
âœ… Non-admin set address correctly prevented
  Error: AnchorError caused by account: state. Error Code: Unauthorized. Error Number: 6000. Error Message: Unauthorized.
      âœ” Should fail when non-admin tries to set address
    Test 2.7: Multiple Rapid Toggles Work Correctly
âš¡ Performing rapid toggles...
  Toggle 1: true
  Toggle 2: false
  Toggle 3: true
  Toggle 4: false
  Toggle 5: true
âœ… Rapid toggles completed successfully
      âœ” Should handle rapid consecutive toggles (1931ms)
âœ… State consistency verified after rapid operations
      âœ” Should maintain state consistency after rapid toggles

âœ… Fee Contract Admin Controls Tests Complete
  Total Tests Passed: 10

  Fee Contract - Stability Pool Distribution Mode

ğŸš€ Setting up Fee Distribution - Stability Pool Mode Tests...
âœ… Setup complete
  Token Mint: GhBd2BJojbyarcu2CszJugPud9VEscfPCbe6P4UKo4vm
  Payer: GV8CPq1VgdXNreaNZJ17UFH8NXiMFb9W1qTeRczLHPhc
  Stake Contract: gboFaubHsbkozptxrWV3kRbFmNuX9gQjCNF72dA2FNm
    Test 3.1: Enable Stake Mode and Set Stake Address
ğŸ”„ Enabling stake mode...
âœ… Stake mode enabled and address set
      âœ” Should enable stake mode and set address (825ms)
    Test 3.2: Distribute Fees to Stability Pool (100% Transfer)
ğŸ’¸ Distributing fees to stability pool...
  Amount: 100000
âœ… Distribution successful. TX: 2reo3QnDUNjeaqjwKQ7WQv7JN4RAuKhhgaRfgo2Uj5o9hQ263KJfBSBYMkya7UnEYWCyRUUeq9VYGdS2gqPtWXye
âœ… 100% of fees transferred to stability pool
      âœ” Should transfer 100% of fees to stability pool (409ms)
    Test 3.3: Verify total_fees_collected Increments Correctly
âœ… total_fees_collected: 150000
      âœ” Should increment total_fees_collected accurately (406ms)
    Test 3.4: Validate Stability Pool Token Account Owner
âœ… Stability pool account owner validated
      âœ” Should verify stability pool account owner matches stake_contract_address
    Test 3.5: Reject Distribution if stake_contract_address is Default
ğŸ”’ Attempting distribution with default stake address...
âœ… Distribution correctly rejected
      âœ” Should fail if stake address is Pubkey::default() (838ms)
    Test 3.6: Reject Distribution if Stability Pool Owner is Wrong
ğŸ”’ Attempting distribution with wrong pool owner...
âœ… Wrong pool owner correctly rejected
      âœ” Should fail if pool account owner doesn't match stake_contract_address (819ms)
    Test 3.7: Validate Token Mint Matches Across Accounts
ğŸ”’ Attempting distribution with mismatched token mints...
âœ… Mismatched token mints correctly rejected
      âœ” Should fail if token mints don't match (1231ms)
    Test 3.8: Test Large Fee Amounts
ğŸ’° Distributing large fee amount: 999999999
âœ… Large amount handled correctly
      âœ” Should handle large fee amounts correctly (377ms)
    Test 3.9: Test Multiple Consecutive Distributions
âš¡ Performing multiple consecutive distributions...
  Distribution 1: 1000 âœ“
  Distribution 2: 2000 âœ“
  Distribution 3: 3000 âœ“
  Distribution 4: 4000 âœ“
  Distribution 5: 5000 âœ“
âœ… Multiple distributions completed
  Total fees collected: 1000164999
      âœ” Should handle multiple consecutive distributions (2043ms)

âœ… Fee Distribution - Stability Pool Mode Tests Complete
  Total Tests Passed: 9

  Fee Contract - Treasury Distribution Mode (50/50 Split)

ğŸš€ Setting up Fee Distribution - Treasury Mode Tests...
âœ… Setup complete
  Token Mint: 46dCKtJK2FiM4FUeaEAy5LkMarnC1sZ5LLJqT6GXmYus
  FEE_ADDR_1: 8Lv4UrYHTrzvg9jPVVGNmxWyMrMvrZnCQLWucBzfJyyR
  FEE_ADDR_2: GcNwV1nA5bityjNYsWwPLHykpKuuhPzK1AQFBbrPopnX
    Test 4.1: Disable Stake Mode (Switch to Treasury)
âœ… Treasury mode active (stake disabled)
      âœ” Should disable stake mode for treasury distribution
    Test 4.2: Distribute Fees 50/50 to FEE_ADDR_1 and FEE_ADDR_2
ğŸ’¸ Distributing fees 50/50 to treasury addresses...
  Total Amount: 100000
âœ… Distribution successful. TX: 4UZgkgDWyiUPkfVo4QHigD5YJSRVoVThuTbZwoLB4vhJEWvki8CBuv4Am3pmsgmmkrAo1w4trzXYtZcUUfadqQ7F
âœ… Fees split 50/50 correctly
  FEE_ADDR_1 received: 50000
  FEE_ADDR_2 received: 50000
      âœ” Should split fees equally between two addresses (408ms)
    Test 4.3: Verify 50/50 Split Calculation (Even Amounts)
  âœ“ 1000 â†’ 500 each
  âœ“ 2000 â†’ 1000 each
  âœ“ 10000 â†’ 5000 each
  âœ“ 100000 â†’ 50000 each
âœ… Even amount splits verified
      âœ” Should calculate 50/50 split correctly for even amounts (1634ms)
    Test 4.4: Verify 50/50 Split Calculation (Odd Amounts)
  âœ“ 1001 â†’ 500 + 501
  âœ“ 2001 â†’ 1000 + 1001
  âœ“ 99999 â†’ 49999 + 50000
âœ… Odd amount splits verified
      âœ” Should handle odd amounts correctly (remainder to addr2) (1230ms)
    Test 4.5: Validate FEE_ADDR_1 Token Account Owner
âœ… FEE_ADDR_1 token account owner validated
      âœ” Should verify FEE_ADDR_1 token account owner is correct
    Test 4.6: Validate FEE_ADDR_2 Token Account Owner
âœ… FEE_ADDR_2 token account owner validated
      âœ” Should verify FEE_ADDR_2 token account owner is correct
    Test 4.7: Reject if Fee Address Token Account Owners are Wrong
ğŸ”’ Attempting distribution with wrong FEE_ADDR_1 owner...
âœ… Wrong FEE_ADDR_1 owner correctly rejected
      âœ” Should fail if FEE_ADDR_1 token account has wrong owner (832ms)
ğŸ”’ Attempting distribution with wrong FEE_ADDR_2 owner...
âœ… Wrong FEE_ADDR_2 owner correctly rejected
      âœ” Should fail if FEE_ADDR_2 token account has wrong owner (809ms)
    Test 4.8: Test Zero Amount Distribution (Should Fail)
ğŸ”’ Attempting distribution with zero amount...
âœ… Zero amount correctly rejected
      âœ” Should reject distribution with zero amount
    Test 4.9: Test total_fees_collected Accumulation
ğŸ“Š Testing total_fees_collected accumulation...
  Starting total: 316001
  After 1000: 317001
  After 2000: 319001
  After 3000: 322001
âœ… total_fees_collected accumulation verified
      âœ” Should accumulate total_fees_collected across multiple distributions (1190ms)

âœ… Fee Distribution - Treasury Mode Tests Complete
  Total Tests Passed: 11

  Fee Contract - Edge Cases & Error Handling

ğŸš€ Setting up Fee Contract Edge Cases Tests...
âœ… Setup complete
    Test 6.1: Distribute 1 Lamport (Minimum Amount)
âš¡ Distributing minimum amount (1)...
âœ… Minimum amount handled. TX: 4GdoD9LAndjF9o3CNoryhBQ9KQeDC73ADLN7hTWvnxoxSWJgZ8wyHdCsev39gU95DW9oNfWBenEbKVAAgTixwxWy
âœ… Minimum amount (1) distributed successfully
      âœ” Should handle minimum amount (1) correctly (410ms)
    Test 6.2: Distribute Maximum u64 Value
âš¡ Distributing large amount: 999999999
âœ… Large amount handled. TX: 4dm6iSK246XeDXeCSC9PZ2C1qDfxNWVvFB44AedeKLhRptBtoF2E7u8BV5e3bMKoYuPpxVHawMfhwVSgprbu1JsB
      âœ” Should handle maximum u64 value if sufficient balance (408ms)
    Test 6.3: Toggle Mode Mid-Operation
ğŸ”„ Testing mode switching...
âœ… Mode switching handled correctly
      âœ” Should handle mode switching correctly (1635ms)
    Test 6.4: Change Stake Address Mid-Operation
ğŸ”„ Testing stake address changes...
âœ… Stake address changes handled correctly
      âœ” Should allow changing stake address between distributions (1225ms)
    Test 6.5: Test with Uninitialized Token Accounts
ğŸ”’ Testing with uninitialized token account...
âœ… Uninitialized account correctly rejected
      âœ” Should fail gracefully with uninitialized accounts
    Test 6.6: Test with Closed Token Accounts
âš ï¸  Closed token account test - conceptual validation
âœ… SPL Token prevents closing accounts with balances
âœ… Contract would reject non-existent accounts
      âœ” Should detect and reject closed token accounts
    Test 6.7: Test Rapid State Changes (Stress Test)
âš¡ Performing rapid state changes...
âœ… Rapid operations completed
      âœ” Should handle rapid consecutive operations (10175ms)
âœ… State consistency verified after stress test
  Total fees collected: 1000061992
      âœ” Should maintain state consistency after stress test
    Test 6.8: Verify All Error Messages are Correct
âœ… NoFeesToDistribute error verified
      âœ” Should return specific error for NoFeesToDistribute
âœ… Unauthorized error verified
      âœ” Should return specific error for Unauthorized (399ms)
âœ… InvalidAddress error verified
      âœ” Should return specific error for InvalidAddress

âœ… Fee Contract Edge Cases Tests Complete
  Total Tests Passed: 13

  Fee Contract - Initialization Tests

ğŸš€ Setting up Fee Contract Initialization Tests...
âœ… Admin funded: CiFSYaWJ5azQAG9ZMQ61E8WAJvjTstf853UkEVkukMyB
    Test 1.1: Initialize Fee Contract Successfully
ğŸ“‹ Initializing fee contract...
  Admin: CiFSYaWJ5azQAG9ZMQ61E8WAJvjTstf853UkEVkukMyB
  State Account: GSQmXg6sVRELSEEHiAuQjavY83nhwfg2pq75gPLRL5aJ
âœ… Fee contract initialized. TX: 4KGVKJuExEHAkSCj7ygC1pfbYykxJ6fqMSYkrvDcESZqk3eey2RiB6NNFxyHAG7oXP8JxofYkaT9XJFW26JWwoqD
âœ… All initial state values verified correctly
      âœ” Should initialize fee contract with correct initial state (417ms)
    Test 1.2: Verify Initial State Properties
âœ… State properties verified:
  admin: CiFSYaWJ5azQAG9ZMQ61E8WAJvjTstf853UkEVkukMyB
  isStakeEnabled: false
  stakeContractAddress: 11111111111111111111111111111111
  totalFeesCollected: 0
      âœ” Should have all expected state properties
    Test 1.3: Prevent Re-initialization
ğŸ”’ Attempting to reinitialize same state account...
âœ… Reinitialization correctly prevented
  Error: Simulation failed. 
Message: Transaction simulation failed: Error processing Instruction 0: custom program error: 0x0. 
Logs: 
[
  "Program h4ka5hAgZ5Ez7x4bjMiAqQHnuwnfry3aBiWNzUw3F7t invoke [1]",
  "Program log: Instruction: Initialize",
  "Program 11111111111111111111111111111111 invoke [2]",
  "Allocate: account Address { address: GSQmXg6sVRELSEEHiAuQjavY83nhwfg2pq75gPLRL5aJ, base: None } already in use",
  "Program 11111111111111111111111111111111 failed: custom program error: 0x0",
  "Program h4ka5hAgZ5Ez7x4bjMiAqQHnuwnfry3aBiWNzUw3F7t consumed 3441 of 200000 compute units",
  "Program h4ka5hAgZ5Ez7x4bjMiAqQHnuwnfry3aBiWNzUw3F7t failed: custom program error: 0x0"
]. 
Catch the `SendTransactionError` and call `getLogs()` on it for full details.
      âœ” Should fail when trying to reinitialize same state account
âœ… New state account initialized successfully. TX: 4TafWwx4uf9MRn1wDnMS6MeFyuQCX5kXbTnonwBgprSRSMA5buQAkC3oVajii1D3kh76Jn69cahS8jTVRsEExmSX
      âœ” Should allow initialization of different state account (782ms)
    Test 1.4: Get Config Returns Correct Values
ğŸ“Š Config retrieved:
  admin: CiFSYaWJ5azQAG9ZMQ61E8WAJvjTstf853UkEVkukMyB
  isStakeEnabled: false
  stakeContractAddress: 11111111111111111111111111111111
  totalFeesCollected: 0
âœ… get_config returns correct initial values
      âœ” Should return correct config immediately after initialization
âœ… get_config is callable by anyone (view function)
      âœ” Should be callable by non-admin (read-only) (395ms)

âœ… Fee Contract Initialization Tests Complete
  Total Tests Passed: 6
  State Account: GSQmXg6sVRELSEEHiAuQjavY83nhwfg2pq75gPLRL5aJ

  Fee Contract - Protocol CPI Integration Tests

ğŸš€ Setting up Fee Contract CPI Integration Tests...
âœ… Setup complete
  Protocol Simulator: CqMHDftpHWKnagqXUhicHfVjMu8FJUPR5ofeHou1XE3v
  Fee State: GbVyPoWAvrHzPJWKk6NQX89WGpzXFiiP2sKSFqEJjp68
    Test 7.1: Protocol Calls distribute_fee via CPI (Stake Mode)
ğŸ“¡ Simulating protocol CPI call (stake mode)...
âœ… Protocol CPI call successful (stake mode). TX: Jb75v2AHiXg63r3vQ3epEF2wCp3o8PVvk4C2qHhjyExVAxXEyFTFrb3RBkMpMZj46Xzb5rEyoH2PsoNXPLrpxC6
      âœ” Should allow protocol to call distribute_fee in stake mode (1228ms)
    Test 7.2: Protocol Calls distribute_fee via CPI (Treasury Mode)
ğŸ“¡ Simulating protocol CPI call (treasury mode)...
âœ… Protocol CPI call successful (treasury mode). TX: 4MxbYAKp3d6fgtkYgsGpvoZuGRQVzCmnBfdnmMY3GHFSA7DCiw8S6eA9s6NSdSLtHSgefhau41FRGwQ91anVxJDz
      âœ” Should allow protocol to call distribute_fee in treasury mode (818ms)
    Test 7.3: Verify CPI Discriminator and Return Data
ğŸ” Verifying CPI instruction processing...
âœ… CPI instruction processed. TX: 2FraWt87J6j6R8uWnmsTFWft28zAg6PfvGb2pUeDVrY48VHP4LuTRWtGedsXPJtEhwUWxpHKM7UVfDHXsNZE9pAF
âœ… Transaction details retrieved successfully
âœ… Transaction details retrieved successfully
      âœ” Should process distribute_fee instruction correctly (1411ms)
    Test 7.4: Test get_fees_config CPI from Protocol
ğŸ“¡ Simulating protocol calling get_fees_config...
ğŸ“Š Config retrieved via CPI simulation:
  admin: J6MsTGqiNfaFznAcqGfvmK25bqUsoYyaGaSCc6FZpqiE
  isStakeEnabled: false
  totalFeesCollected: 175000
âœ… get_fees_config CPI working correctly
      âœ” Should allow protocol to query config via view function
    Test 7.5: Validate Cross-Program State Consistency
ğŸ”„ Testing state consistency across multiple CPI calls...
âœ… Cross-program state consistency verified
      âœ” Should maintain consistent state across CPI calls (1025ms)
    Test 7.6: Test Fee Distribution During Protocol Operations
âš¡ Simulating protocol operations with fee distribution...
  Simulating open_trove with fee 5000...
  âœ“ open_trove complete
  Simulating borrow_loan with fee 3000...
  âœ“ borrow_loan complete
  Simulating repay_loan with fee 2000...
  âœ“ repay_loan complete
  Simulating add_collateral with fee 1000...
  âœ“ add_collateral complete
âœ… All protocol operations with fees simulated successfully
ğŸ“Š Final fee state:
  Total fees collected: 192000
  Stake enabled: false
      âœ” Should simulate fee distribution during protocol operations (1638ms)

âœ… Fee Contract CPI Integration Tests Complete
  Total Tests Passed: 6
  CPI integration fully validated

  Fee Contract - Security & Attack Prevention

ğŸš€ Setting up Fee Contract Security Tests...
âœ… Setup complete
  Attacker: A4ak7XdHjCgkxFQ9u88KGeSRwkDxrcyQTpcsLzjXz81c
    Test 5.1: Reject Unauthorized payer_token_account
ğŸ”’ Attempting to drain funds with unauthorized account...
âœ… Unauthorized payer_token_account correctly rejected
  Error: AnchorError thrown in programs/aerospacer-fees/src/instructions/distribute_fee.rs:45. Error Code: UnauthorizedTokenAccount. Error Number: 6011. Error Message: Unauthorized token account - payer must own the payer_token_account.
      âœ” Should fail if payer doesn't own payer_token_account
âœ… Authorized payer succeeds. TX: 44FBdEuX5pyfmMCAWnzr2jvdvaDYwKSdScg3LyL7622DeUS7KPYWPXP5PxsTySa9kkZ2Ufwwu2RFTMfz59ovdfcJ
      âœ” Should succeed if payer owns payer_token_account (377ms)
    Test 5.2: Reject Mixed Token Mints
ğŸ”’ Attempting distribution with mismatched stability pool mint...
âœ… Mixed token mints correctly rejected
      âœ” Should fail when stability pool has different mint (2043ms)
ğŸ”’ Attempting distribution with mismatched fee address mint...
âœ… Mixed fee address mints correctly rejected
      âœ” Should fail when fee addresses have different mints (837ms)
    Test 5.3: Test Overflow Protection on total_fees_collected
âš ï¸  Testing overflow protection...
âœ… Insufficient funds or overflow protection active
      âœ” Should handle near-max values safely
    Test 5.4: Prevent Fee Distribution with Zero Amount
ğŸ”’ Attempting distribution with zero amount...
âœ… Zero amount correctly rejected
      âœ” Should reject zero amount distribution
    Test 5.5: Validate All Token Account Ownership Checks
ğŸ”’ Testing payer ownership validation...
âœ… Attacker cannot use payer's account
      âœ” Should validate payer owns payer_token_account
    Test 5.6: Test CPI Security
âœ… distribute_fee can be called by anyone (designed for protocol CPI)
   Security relies on payer_token_account ownership validation
âœ… Legitimate call succeeds. TX: 64E8uEGaLH7qNVxue5BPaZ113WZMqwgj721tZ1t4eWC3w7RxHLcVjXVGDypLN9BXvjWwdWCkUH6MfumeifNW2vGF
      âœ” Should only allow legitimate protocol to call distribute_fee (318ms)
    Test 5.7: Attempt to Drain Funds with Fake Accounts
ğŸ”’ Comprehensive attack prevention test...
  Testing: Unauthorized payer_token_account...
  âœ“ Unauthorized payer_token_account prevented
  Testing: Wrong token mint...
  âœ“ Wrong token mint prevented
âœ… All attack scenarios prevented
      âœ” Should prevent fund draining with all security checks (1246ms)

âœ… Fee Contract Security Tests Complete
  Total Tests Passed: 12
  All attack vectors successfully prevented


  61 passing (1m)

taha@HP-Probook:~/Documents/Projects/Aeroscraper/aerospacer-solana$ 